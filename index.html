<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Family Fitness Leaderboard</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --background: #0f0f11;
      --card: #18181b;
      --muted: #24242a;
      --primary: #0fd9c4;
      --primary-glow: #14f5dc;
      --secondary: #ff7a1a;
      --success: #8fd919;
      --text: #fafafa;
      --text-muted: #a1a1aa;
      --border: #27272a;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Space Grotesk', system-ui, -apple-system, sans-serif;
      background: var(--background);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      -webkit-font-smoothing: antialiased;
    }

    /* PIN Entry Screen */
    .pin-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 32px;
      max-width: 320px;
      width: 100%;
    }

    .pin-screen.hidden {
      display: none;
    }

    .pin-title {
      text-align: center;
    }

    .pin-title h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .pin-title p {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    .pin-dots {
      display: flex;
      gap: 16px;
    }

    .pin-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid var(--text-muted);
      background: transparent;
      transition: all 0.15s ease;
    }

    .pin-dot.filled {
      background: var(--primary);
      border-color: var(--primary);
      box-shadow: 0 0 12px rgba(15, 217, 196, 0.5);
    }

    .pin-dot.error {
      background: #ef4444;
      border-color: #ef4444;
      animation: shake 0.4s ease;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }

    .pin-pad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      width: 100%;
    }

    .pin-key {
      aspect-ratio: 1;
      max-width: 80px;
      width: 100%;
      margin: 0 auto;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-size: 1.75rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .pin-key:hover {
      background: var(--muted);
      border-color: var(--primary);
    }

    .pin-key:active {
      transform: scale(0.95);
      background: var(--primary);
      color: var(--background);
    }

    .pin-key .letters {
      font-size: 0.6rem;
      color: var(--text-muted);
      letter-spacing: 2px;
      margin-top: 2px;
    }

    .pin-key.empty {
      visibility: hidden;
    }

    .pin-key.backspace {
      font-size: 1.25rem;
    }

    /* Leaderboard Screen */
    .leaderboard-screen {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      max-width: 400px;
      width: 100%;
      animation: fadeIn 0.5s ease;
    }

    .leaderboard-screen.visible {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .leaderboard-header {
      text-align: center;
    }

    .leaderboard-header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .leaderboard-header p {
      color: var(--text-muted);
      font-size: 0.875rem;
      margin-top: 4px;
    }

    .leaderboard-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 100%;
      overflow: hidden;
    }

    .leaderboard-row {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      gap: 14px;
      border-bottom: 1px solid var(--border);
      animation: slideIn 0.4s ease backwards;
    }

    .leaderboard-row:last-child {
      border-bottom: none;
    }

    .leaderboard-row:nth-child(1) { animation-delay: 0.1s; }
    .leaderboard-row:nth-child(2) { animation-delay: 0.2s; }
    .leaderboard-row:nth-child(3) { animation-delay: 0.3s; }
    .leaderboard-row:nth-child(4) { animation-delay: 0.4s; }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .rank {
      font-size: 1.5rem;
      width: 36px;
      text-align: center;
    }

    .rank.gold { color: #fbbf24; }
    .rank.silver { color: #94a3b8; }
    .rank.bronze { color: #d97706; }
    .rank.fourth { color: var(--text-muted); font-size: 1.1rem; }

    .avatar {
      font-size: 2rem;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--muted);
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid var(--border);
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .avatar-initials {
      font-size: 1rem;
      font-weight: 600;
      color: var(--primary);
    }

    .member-info {
      flex: 1;
    }

    .member-name {
      font-weight: 600;
      font-size: 1rem;
    }

    .progress-bar {
      height: 6px;
      background: var(--muted);
      border-radius: 3px;
      margin-top: 6px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.8s ease;
    }

    .progress-fill.first { background: linear-gradient(90deg, var(--primary), var(--primary-glow)); }
    .progress-fill.second { background: var(--primary); opacity: 0.7; }
    .progress-fill.third { background: var(--secondary); }
    .progress-fill.fourth { background: var(--text-muted); }

    .workout-count {
      font-weight: 700;
      font-size: 1rem;
      color: var(--primary);
      text-align: right;
      min-width: 80px;
    }

    .workout-count span {
      display: block;
      font-size: 0.7rem;
      font-weight: 400;
      color: var(--text-muted);
    }

    .member-stats {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .stat-badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 4px;
      background: var(--muted);
      color: var(--text-muted);
    }

    .stat-badge.streak {
      background: rgba(251, 146, 60, 0.15);
      color: #fb923c;
    }

    .stat-badge.streak.hot {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .stat-badge.goal {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .stat-badge.goal.incomplete {
      background: rgba(113, 113, 122, 0.1);
      color: var(--text-muted);
    }

    .app-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      background: var(--muted);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      text-decoration: none;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .app-link:hover {
      background: var(--primary);
      color: var(--background);
      border-color: var(--primary);
    }

    .back-link {
      position: fixed;
      top: 16px;
      left: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.8rem;
      transition: all 0.2s ease;
    }

    .back-link:hover {
      color: var(--primary);
      border-color: var(--primary);
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 40px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--muted);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      text-align: center;
      padding: 20px;
      color: #ef4444;
    }
  </style>
</head>
<body>
  <a href="https://themekhailfamily.com" class="back-link">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M19 12H5M12 19l-7-7 7-7"/>
    </svg>
    Dashboard
  </a>

  <!-- PIN Entry Screen -->
  <div id="pin-screen" class="pin-screen">
    <div class="pin-title">
      <h1>Family Leaderboard</h1>
      <p>Enter PIN to view</p>
    </div>

    <div class="pin-dots">
      <div class="pin-dot" data-index="0"></div>
      <div class="pin-dot" data-index="1"></div>
      <div class="pin-dot" data-index="2"></div>
      <div class="pin-dot" data-index="3"></div>
    </div>

    <div class="pin-pad">
      <button class="pin-key" data-key="1">1</button>
      <button class="pin-key" data-key="2">2<span class="letters">ABC</span></button>
      <button class="pin-key" data-key="3">3<span class="letters">DEF</span></button>
      <button class="pin-key" data-key="4">4<span class="letters">GHI</span></button>
      <button class="pin-key" data-key="5">5<span class="letters">JKL</span></button>
      <button class="pin-key" data-key="6">6<span class="letters">MNO</span></button>
      <button class="pin-key" data-key="7">7<span class="letters">PQRS</span></button>
      <button class="pin-key" data-key="8">8<span class="letters">TUV</span></button>
      <button class="pin-key" data-key="9">9<span class="letters">WXYZ</span></button>
      <button class="pin-key empty"></button>
      <button class="pin-key" data-key="0">0</button>
      <button class="pin-key backspace" data-key="back">‚å´</button>
    </div>
  </div>

  <!-- Leaderboard Screen -->
  <div id="leaderboard-screen" class="leaderboard-screen">
    <div class="leaderboard-header">
      <h1>üèÜ Family Leaderboard</h1>
      <p id="week-label">Week of Dec 16 - Dec 22</p>
    </div>

    <div class="leaderboard-card" id="leaderboard-content">
      <div class="loading">
        <div class="spinner"></div>
        <p>Loading stats...</p>
      </div>
    </div>

    <a href="https://workout.themekhailfamily.com" class="app-link">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 8h1a4 4 0 0 1 0 8h-1M6 8H5a4 4 0 0 0 0 8h1M6 12h12"/>
      </svg>
      Open Workout App
    </a>
  </div>

  <script>
    // ============================================
    // CONFIGURATION - UPDATE THESE WITH REAL IDs
    // ============================================
    const CORRECT_PIN = '7707';

    // Family member avatars (keys must match database names exactly)
    // Using absolute URLs because subdomain rewrites prevent relative paths from loading
    const AVATAR_OVERRIDES = {
      'saxyn': 'https://themekhailfamily.com/saxynpfp.png',
      'Saxyn': 'https://themekhailfamily.com/saxynpfp.png',
      'Kingston': 'https://themekhailfamily.com/kingstonpfp.jpg',
      'kingston': 'https://themekhailfamily.com/kingstonpfp.jpg',
      'Danielle': 'https://unavatar.io/instagram/mamamekhail',
      'danielle': 'https://unavatar.io/instagram/mamamekhail',
      'George': 'https://themekhailfamily.com/georgepfp.jpg',
      'george': 'https://themekhailfamily.com/georgepfp.jpg',
    };

    // Helper to render avatar (image URL or initials)
    function renderAvatar(name) {
      const avatarUrl = AVATAR_OVERRIDES[name];
      const initial = name ? name[0] : '?';
      if (avatarUrl) {
        return `<img src="${avatarUrl}" alt="${name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" /><span class="avatar-initials" style="display:none;">${initial}</span>`;
      }
      return `<span class="avatar-initials">${initial}</span>`;
    }

    const SUPABASE_URL = 'https://stedvrfqwnmerjugmnkd.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN0ZWR2cmZxd25tZXJqdWdtbmtkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NDE5MTksImV4cCI6MjA3OTQxNzkxOX0.GVwNfT-n1ji95PQxpYTi08rZuTXFlFjTksGmVLUcDKM';

    // ============================================
    // PIN PAD LOGIC
    // ============================================
    let enteredPin = '';
    const pinDots = document.querySelectorAll('.pin-dot');
    const pinScreen = document.getElementById('pin-screen');
    const leaderboardScreen = document.getElementById('leaderboard-screen');

    // Check if already unlocked this session
    if (sessionStorage.getItem('leaderboard_unlocked') === 'true') {
      showLeaderboard();
    }

    document.querySelectorAll('.pin-key').forEach(key => {
      key.addEventListener('click', () => {
        const value = key.dataset.key;

        if (value === 'back') {
          if (enteredPin.length > 0) {
            enteredPin = enteredPin.slice(0, -1);
            updateDots();
          }
        } else if (value && enteredPin.length < 4) {
          enteredPin += value;
          updateDots();

          if (enteredPin.length === 4) {
            setTimeout(checkPin, 150);
          }
        }
      });
    });

    function updateDots() {
      pinDots.forEach((dot, i) => {
        dot.classList.toggle('filled', i < enteredPin.length);
        dot.classList.remove('error');
      });
    }

    function checkPin() {
      if (enteredPin === CORRECT_PIN) {
        sessionStorage.setItem('leaderboard_unlocked', 'true');
        showLeaderboard();
      } else {
        // Show error animation
        pinDots.forEach(dot => {
          dot.classList.add('error');
          dot.classList.remove('filled');
        });
        enteredPin = '';

        // Reset after animation
        setTimeout(() => {
          pinDots.forEach(dot => dot.classList.remove('error'));
        }, 400);
      }
    }

    function showLeaderboard() {
      pinScreen.classList.add('hidden');
      leaderboardScreen.classList.add('visible');
      loadLeaderboardData();
    }

    // ============================================
    // LEADERBOARD DATA
    // ============================================
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function getWeekDates() {
      const now = new Date();
      const dayOfWeek = now.getDay();
      const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;

      const monday = new Date(now);
      monday.setDate(now.getDate() + diffToMonday);
      monday.setHours(0, 0, 0, 0);

      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);

      return {
        start: monday.toISOString().split('T')[0],
        end: sunday.toISOString().split('T')[0],
        label: `Week of ${monday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${sunday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`
      };
    }

    // Calculate streak from workout dates
    function calculateStreak(workoutDates) {
      if (!workoutDates || workoutDates.length === 0) return 0;

      // Sort dates descending
      const sortedDates = [...new Set(workoutDates)].sort((a, b) => new Date(b) - new Date(a));

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);

      const todayStr = today.toISOString().split('T')[0];
      const yesterdayStr = yesterday.toISOString().split('T')[0];

      // Check if most recent workout is today or yesterday
      if (sortedDates[0] !== todayStr && sortedDates[0] !== yesterdayStr) {
        return 0; // Streak broken
      }

      let streak = 0;
      let checkDate = sortedDates[0] === todayStr ? today : yesterday;

      for (const dateStr of sortedDates) {
        const checkDateStr = checkDate.toISOString().split('T')[0];
        if (dateStr === checkDateStr) {
          streak++;
          checkDate.setDate(checkDate.getDate() - 1);
        } else if (dateStr < checkDateStr) {
          break; // Gap in dates, streak ends
        }
      }

      return streak;
    }

    async function loadLeaderboardData() {
      const weekDates = getWeekDates();
      document.getElementById('week-label').textContent = weekDates.label;

      const contentEl = document.getElementById('leaderboard-content');

      try {
        // Step 1: Fetch all profiles with weekly target
        const { data: profiles, error: profileError } = await supabaseClient
          .from('profiles')
          .select('id, name, days_per_week_target');

        if (profileError) throw profileError;

        if (!profiles || profiles.length === 0) {
          contentEl.innerHTML = `<div class="error-message"><p>No family members found yet.</p></div>`;
          return;
        }

        // Step 2: Fetch ALL completed workouts (for streak calculation)
        const { data: allSessions, error: allSessionError } = await supabaseClient
          .from('workout_sessions')
          .select('user_id, date')
          .in('user_id', profiles.map(p => p.id))
          .eq('status', 'completed')
          .order('date', { ascending: false });

        if (allSessionError) throw allSessionError;

        // Count workouts per user for this week and calculate streaks
        const weekCounts = {};
        const allDates = {};
        profiles.forEach(p => {
          weekCounts[p.id] = 0;
          allDates[p.id] = [];
        });

        if (allSessions) {
          allSessions.forEach(session => {
            if (allDates[session.user_id] !== undefined) {
              allDates[session.user_id].push(session.date);
              // Count if in this week
              if (session.date >= weekDates.start && session.date <= weekDates.end) {
                weekCounts[session.user_id]++;
              }
            }
          });
        }

        // Build leaderboard data
        const leaderboard = profiles.map(profile => ({
          id: profile.id,
          name: profile.name.split(' ')[0], // First name only
          workouts: weekCounts[profile.id] || 0,
          weeklyTarget: profile.days_per_week_target || 3,
          streak: calculateStreak(allDates[profile.id])
        })).sort((a, b) => b.workouts - a.workouts);

        // Find max for progress bar scaling
        const maxWorkouts = Math.max(...leaderboard.map(m => m.workouts), 1);

        // Render leaderboard
        contentEl.innerHTML = leaderboard.map((member, index) => {
          const rankClass = ['gold', 'silver', 'bronze', 'fourth'][index] || 'fourth';
          const rankEmoji = ['ü•á', 'ü•à', 'ü•â'][index] || (index + 1);
          const progressClass = ['first', 'second', 'third', 'fourth'][index] || 'fourth';
          const progressWidth = (member.workouts / maxWorkouts) * 100;

          const goalMet = member.workouts >= member.weeklyTarget;
          const streakClass = member.streak >= 7 ? 'hot' : '';
          const goalClass = goalMet ? '' : 'incomplete';

          return `
            <div class="leaderboard-row">
              <div class="rank ${rankClass}">${rankEmoji}</div>
              <div class="avatar">${renderAvatar(member.name)}</div>
              <div class="member-info">
                <div class="member-name">${member.name}</div>
                <div class="member-stats">
                  <span class="stat-badge streak ${streakClass}">üî• ${member.streak} day${member.streak !== 1 ? 's' : ''}</span>
                  <span class="stat-badge goal ${goalClass}">${goalMet ? '‚úì' : ''} ${member.workouts}/${member.weeklyTarget}</span>
                </div>
              </div>
              <div class="workout-count">
                ${member.workouts}
                <span>${member.workouts === 1 ? 'workout' : 'workouts'}</span>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Failed to load leaderboard:', err);
        contentEl.innerHTML = `
          <div class="error-message">
            <p>Failed to load leaderboard data.</p>
            <p style="font-size: 0.8rem; margin-top: 8px; color: var(--text-muted);">
              Make sure user IDs are configured correctly.
            </p>
          </div>
        `;
      }
    }
  </script>
</body>
</html>
